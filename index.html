<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shipzu Grid • Lite Challenge</title>
    <style>
      :root { --bg:#0b1020; --card:#121833; --text:#e7eaf6; --muted:#9aa3b2; --ok:#1fbf75; --warn:#f5b942; --bad:#ff5d5d; }
      * { box-sizing: border-box; }
      body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background: var(--bg); color: var(--text); }
      header { padding: 16px 20px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #1f2747; }
      .brand { font-weight:700; letter-spacing:0.3px; }
      .meta { color: var(--muted); font-size:14px; }
      main { max-width: 980px; margin: 24px auto; padding: 0 16px; }
      .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:14px; }
      .card { background: var(--card); border-radius: 16px; padding: 16px; box-shadow: 0 10px 24px rgba(0,0,0,0.15); }
      .card.ok { background: color-mix(in srgb, var(--ok) 10%, var(--card)); border:1px solid color-mix(in srgb, var(--ok) 30%, transparent); }
      .card.warn { background: color-mix(in srgb, var(--warn) 10%, var(--card)); border:1px solid color-mix(in srgb, var(--warn) 30%, transparent); }
      .card.bad { background: color-mix(in srgb, var(--bad) 10%, var(--card)); border:1px solid color-mix(in srgb, var(--bad) 30%, transparent); }
      .kpi-title { font-size:14px; color: var(--muted); margin-bottom:6px; }
      .kpi-value { font-size:28px; font-weight:700; }
      .badge { display:inline-block; margin-top:8px; padding: 4px 8px; border-radius: 999px; font-size:12px; }
      .ok { background: color-mix(in srgb, var(--ok) 18%, transparent); color: var(--ok); border:1px solid color-mix(in srgb, var(--ok) 60%, transparent); }
      .warn { background: color-mix(in srgb, var(--warn) 18%, transparent); color: var(--warn); border:1px solid color-mix(in srgb, var(--warn) 60%, transparent); }
      .bad { background: color-mix(in srgb, var(--bad) 18%, transparent); color: var(--bad); border:1px solid color-mix(in srgb, var(--bad) 60%, transparent); }
      .panel { display:flex; gap:10px; flex-wrap:wrap; align-items:end; margin: 12px 0 20px; }
      label { display:block; font-size:12px; color: var(--muted); margin-bottom:6px; }
      input { background:#0f1630; color:#e7eaf6; border:1px solid #2a3563; padding:10px 12px; border-radius:12px; min-width:110px; }
      button { background:#2a5cff; color:white; border:0; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; }
      button:active { transform: translateY(1px); }
      ul { margin-top: 10px; }
      .muted { color: var(--muted); }
      footer { text-align:center; padding:24px; color: var(--muted); }
      a { color:#8fb3ff; }
      .row { display:flex; gap:14px; flex-wrap:wrap; }
      .wider { grid-column: span 2; }
      @media (max-width: 700px) { .wider { grid-column: span 1; } }
      .sr-only { position:absolute; left:-10000px; width:1px; height:1px; overflow:hidden; }
    </style>
  </head>
  <body>
    <header>
      <div>
        <div class="brand">Shipzu Grid — Lite Challenge</div>
        <div class="meta">IST timezone</div>
      </div>
      <div class="meta" id="lastUpdated">Not submitted</div>
    </header>
    <main>
      <section class="panel">
        <div>
          <label for="tpDelivered">Delivered % target</label>
          <input id="tpDelivered" type="number" value="85" />
        </div>
        <div>
          <label for="tpRto">RTO % target</label>
          <input id="tpRto" type="number" value="8" />
        </div>
        <div>
          <label for="tpRisk">Orders at Risk target</label>
          <input id="tpRisk" type="number" value="20" />
        </div>
        <div>
          <button id="btnEvaluate">Evaluate</button>
        </div>
        <div class="muted">Data source: <code>submission.json</code></div>
      </section>

      <section class="grid">
        <div class="card" id="cardDelivered">
          <div class="kpi-title">Delivered %</div>
          <div class="kpi-value" id="deliveredPercent">–</div>
          <span class="badge" id="badgeDelivered">–</span>
        </div>
        <div class="card" id="cardRto">
          <div class="kpi-title">RTO %</div>
          <div class="kpi-value" id="rtoPercent">–</div>
          <span class="badge" id="badgeRto">–</span>
        </div>
        <div class="card" id="cardRisk">
          <div class="kpi-title">Orders at Risk</div>
          <div class="kpi-value" id="ordersAtRisk">–</div>
          <span class="badge" id="badgeRisk">–</span>
        </div>
        <div class="card ok">
          <div class="kpi-title">Daily Run Rate (DRR)</div>
          <div class="kpi-value" id="drr">–</div>
          <span class="badge ok">info</span>
        </div>
      </section>

      <section class="card" style="margin-top:16px;">
        <details>
          <summary>Rules Output</summary>
          <ul id="rulesList" class="muted"><li>Loading…</li></ul>
        </details>
      </section>

      <section class="card" style="margin-top:16px;">
        <details>
          <summary>Validation payload (for reviewers)</summary>
          <pre id="validationOut" class="muted" style="white-space:pre-wrap;"></pre>
        </details>
      </section>
    </main>

    <footer>
    <a href="submission.json" target="_blank" rel="noopener">Open submission.json</a>
    </footer>

    <script>
      function setBadge(el, good, near=false) {
        el.className = "badge " + (good ? "ok" : (near ? "warn" : "bad"));
        el.textContent = good ? "OK" : (near ? "NEAR" : "ALERT");
      }
      function setCardColor(el, good, near=false) {
        el.classList.remove("ok", "warn", "bad");
        if (good) el.classList.add("ok");
        else if (near) el.classList.add("warn");
        else el.classList.add("bad");
      }
      function pct(n) { return Number(n).toFixed(2) + "%"; }
      function fmt(n) { return String(n); }

      async function main() {
        try {
          const res = await fetch("submission.json", { cache: "no-store" });
          if (!res.ok) throw new Error("Failed to load submission.json");
          const sub = await res.json();

          const k = sub.kpi || {};
          const t = (sub.rules_thresholds) || { delivered_percent:85, rto_percent:8, orders_at_risk:20 };

          tpDelivered.value = t.delivered_percent;
          tpRto.value = t.rto_percent;
          tpRisk.value = t.orders_at_risk;

          deliveredPercent.textContent = pct(k.delivered_percent ?? 0);
          rtoPercent.textContent = pct(k.rto_percent ?? 0);
          ordersAtRisk.textContent = fmt(k.orders_at_risk ?? 0);
          drr.textContent = Number(k.drr ?? 0).toFixed(3);
          

          evaluate(sub);
          btnEvaluate.addEventListener("click", () => evaluate(sub));
        } catch (e) {
          console.error(e);
          document.getElementById("rulesList").innerHTML = "<li>Could not load submission.json</li>";
        }
      }

      function evaluate(sub) {
        const k = sub.kpi || {};
        const thr = {
          delivered_percent: Number(tpDelivered.value),
          rto_percent: Number(tpRto.value),
          orders_at_risk: Number(tpRisk.value),
        };
        const rules = [];

        // --- update submission time on evaluate ---
        const now = new Date();
        const istOptions = { timeZone: 'Asia/Kolkata', hour12: false, 
                             year: 'numeric', month: '2-digit', day: '2-digit',
                             hour: '2-digit', minute: '2-digit', second: '2-digit' };
        const submittedTime = now.toLocaleString('sv-SE', istOptions);
        document.getElementById("lastUpdated").textContent = "Submitted at " + submittedTime;
        // ------------------------------------------

        const del = Number(k.delivered_percent || 0);
        const deliveredGood = del >= thr.delivered_percent;
        const deliveredNear = del >= thr.delivered_percent * 0.9;
        setBadge(badgeDelivered, deliveredGood, deliveredNear);
        setCardColor(cardDelivered, deliveredGood, deliveredNear);
        if (del < thr.delivered_percent) rules.push({kpi:"delivered_percent", actual: del, target: thr.delivered_percent, severity:(del < thr.delivered_percent*0.9 ? "high":"medium")});

        const rto = Number(k.rto_percent || 0);
        const rtoGood = rto <= thr.rto_percent;
        const rtoNear = rto <= thr.rto_percent * 1.1;
        setBadge(badgeRto, rtoGood, !rtoGood && rtoNear);
        setCardColor(cardRto, rtoGood, rtoNear);
        if (!rtoGood) rules.push({kpi:"rto_percent", actual:rto, target: thr.rto_percent, severity:(rto > thr.rto_percent*1.1 ? "medium":"low")});

        const risk = Number(k.orders_at_risk || 0);
        const riskGood = risk <= thr.orders_at_risk;
        const riskNear = risk <= thr.orders_at_risk * 1.1;
        setBadge(badgeRisk, riskGood, !riskGood && riskNear);
        setCardColor(cardRisk, riskGood, riskNear);
        if (!riskGood) rules.push({kpi:"orders_at_risk", actual:risk, target:thr.orders_at_risk, severity:(risk > thr.orders_at_risk*1.1 ? "medium":"low")});

        if (!rules.length) {
          rulesList.innerHTML = '<li class="ok">No alerts</li>';
        } else {
          rulesList.innerHTML = rules.map(r => `<li><strong>${r.kpi}</strong> ⇒ actual: <code>${r.actual.toFixed(2)}</code>, target: <code>${r.target}</code> <em>(${r.severity})</em></li>`).join("");
        }

        const payload = {
          submitted_at_ist: submittedTime,
          kpi: sub.kpi || {},
          thresholds_used: thr,
          rules_computed_client: rules
        };
        validationOut.textContent = JSON.stringify(payload, null, 2);
      }

      main();
    </script>
  </body>
</html>
